DataverseUse q5_local_supplier
TypeDecl LineItemType [
  closed RecordType {
    l_orderkey : int32,
    l_partkey : int32,
    l_suppkey : int32,
    l_linenumber : int32,
    l_quantity : double,
    l_extendedprice : double,
    l_discount : double,
    l_tax : double,
    l_returnflag : string,
    l_linestatus : string,
    l_shipdate : string,
    l_commitdate : string,
    l_receiptdate : string,
    l_shipinstruct : string,
    l_shipmode : string,
    l_comment : string
  }
]
TypeDecl OrderType [
  closed RecordType {
    o_orderkey : int32,
    o_custkey : int32,
    o_orderstatus : string,
    o_totalprice : double,
    o_orderdate : string,
    o_orderpriority : string,
    o_clerk : string,
    o_shippriority : int32,
    o_comment : string
  }
]
TypeDecl CustomerType [
  closed RecordType {
    c_custkey : int32,
    c_name : string,
    c_address : string,
    c_nationkey : int32,
    c_phone : string,
    c_acctbal : double,
    c_mktsegment : string,
    c_comment : string
  }
]
TypeDecl SupplierType [
  closed RecordType {
    s_suppkey : int32,
    s_name : string,
    s_address : string,
    s_nationkey : int32,
    s_phone : string,
    s_acctbal : double,
    s_comment : string
  }
]
TypeDecl NationType [
  closed RecordType {
    n_nationkey : int32,
    n_name : string,
    n_regionkey : int32,
    n_comment : string
  }
]
TypeDecl RegionType [
  closed RecordType {
    r_regionkey : int32,
    r_name : string,
    r_comment : string
  }
]
DatasetDecl LineItems(LineItemType) partitioned by [[l_orderkey], [l_linenumber]]
DatasetDecl Orders(OrderType) partitioned by [[o_orderkey]]
DatasetDecl Customers(CustomerType) partitioned by [[c_custkey]]
DatasetDecl Suppliers(SupplierType) partitioned by [[s_suppkey]]
DatasetDecl Nations(NationType) partitioned by [[n_nationkey]]
DatasetDecl Regions(RegionType) partitioned by [[r_regionkey]]
WriteOutputTo asterix_nc1:/tmp/q5_local_supplier.adm
Query:
SELECT ELEMENT [
RecordConstructor [
  (
    LiteralExpr [STRING] [n_name]
    :
    Variable [ Name=n_name ]
  )
  (
    LiteralExpr [STRING] [revenue]
    :
    Variable [ Name=revenue ]
  )
]
]
FROM [  FunctionCall Metadata.dataset@1[
    LiteralExpr [STRING] [Customers]
  ]
  AS
  Variable [ Name=c ]
,
  (
    SELECT ELEMENT [
    RecordConstructor [
      (
        LiteralExpr [STRING] [n_name]
        :
        FieldAccessor [
          Variable [ Name=l1 ]
          Field=n_name
        ]
      )
      (
        LiteralExpr [STRING] [l_extendedprice]
        :
        FieldAccessor [
          Variable [ Name=l1 ]
          Field=l_extendedprice
        ]
      )
      (
        LiteralExpr [STRING] [l_discount]
        :
        FieldAccessor [
          Variable [ Name=l1 ]
          Field=l_discount
        ]
      )
      (
        LiteralExpr [STRING] [s_nationkey]
        :
        FieldAccessor [
          Variable [ Name=l1 ]
          Field=s_nationkey
        ]
      )
      (
        LiteralExpr [STRING] [o_custkey]
        :
        FieldAccessor [
          Variable [ Name=o ]
          Field=o_custkey
        ]
      )
    ]
    ]
    FROM [      FunctionCall Metadata.dataset@1[
        LiteralExpr [STRING] [Orders]
      ]
      AS
      Variable [ Name=o ]
,
      (
        SELECT ELEMENT [
        RecordConstructor [
          (
            LiteralExpr [STRING] [n_name]
            :
            FieldAccessor [
              Variable [ Name=s1 ]
              Field=n_name
            ]
          )
          (
            LiteralExpr [STRING] [l_extendedprice]
            :
            FieldAccessor [
              Variable [ Name=l ]
              Field=l_extendedprice
            ]
          )
          (
            LiteralExpr [STRING] [l_discount]
            :
            FieldAccessor [
              Variable [ Name=l ]
              Field=l_discount
            ]
          )
          (
            LiteralExpr [STRING] [l_orderkey]
            :
            FieldAccessor [
              Variable [ Name=l ]
              Field=l_orderkey
            ]
          )
          (
            LiteralExpr [STRING] [s_nationkey]
            :
            FieldAccessor [
              Variable [ Name=s1 ]
              Field=s_nationkey
            ]
          )
        ]
        ]
        FROM [          FunctionCall Metadata.dataset@1[
            LiteralExpr [STRING] [LineItems]
          ]
          AS
          Variable [ Name=l ]
,
          (
            SELECT ELEMENT [
            RecordConstructor [
              (
                LiteralExpr [STRING] [n_name]
                :
                FieldAccessor [
                  Variable [ Name=n1 ]
                  Field=n_name
                ]
              )
              (
                LiteralExpr [STRING] [s_suppkey]
                :
                FieldAccessor [
                  Variable [ Name=s ]
                  Field=s_suppkey
                ]
              )
              (
                LiteralExpr [STRING] [s_nationkey]
                :
                FieldAccessor [
                  Variable [ Name=s ]
                  Field=s_nationkey
                ]
              )
            ]
            ]
            FROM [              FunctionCall Metadata.dataset@1[
                LiteralExpr [STRING] [Suppliers]
              ]
              AS
              Variable [ Name=s ]
,
              (
                SELECT ELEMENT [
                RecordConstructor [
                  (
                    LiteralExpr [STRING] [n_name]
                    :
                    FieldAccessor [
                      Variable [ Name=n ]
                      Field=n_name
                    ]
                  )
                  (
                    LiteralExpr [STRING] [n_nationkey]
                    :
                    FieldAccessor [
                      Variable [ Name=n ]
                      Field=n_nationkey
                    ]
                  )
                ]
                ]
                FROM [                  FunctionCall Metadata.dataset@1[
                    LiteralExpr [STRING] [Nations]
                  ]
                  AS
                  Variable [ Name=n ]
,
                  FunctionCall Metadata.dataset@1[
                    LiteralExpr [STRING] [Regions]
                  ]
                  AS
                  Variable [ Name=r ]
                ]
                Where
                  OperatorExpr [
                    OperatorExpr [
                      FieldAccessor [
                        Variable [ Name=n ]
                        Field=n_regionkey
                      ]
                      =
                      FieldAccessor [
                        Variable [ Name=r ]
                        Field=r_regionkey
                      ]
                    ]
                    and
                    OperatorExpr [
                      FieldAccessor [
                        Variable [ Name=r ]
                        Field=r_name
                      ]
                      =
                      LiteralExpr [STRING] [ASIA]
                    ]
                  ]
              )
              AS
              Variable [ Name=n1 ]
            ]
            Where
              OperatorExpr [
                FieldAccessor [
                  Variable [ Name=s ]
                  Field=s_nationkey
                ]
                =
                FieldAccessor [
                  Variable [ Name=n1 ]
                  Field=n_nationkey
                ]
              ]
          )
          AS
          Variable [ Name=s1 ]
        ]
        Where
          OperatorExpr [
            FieldAccessor [
              Variable [ Name=l ]
              Field=l_suppkey
            ]
            =
            FieldAccessor [
              Variable [ Name=s1 ]
              Field=s_suppkey
            ]
          ]
      )
      AS
      Variable [ Name=l1 ]
    ]
    Where
      OperatorExpr [
        OperatorExpr [
          FieldAccessor [
            Variable [ Name=l1 ]
            Field=l_orderkey
          ]
          =
          FieldAccessor [
            Variable [ Name=o ]
            Field=o_orderkey
          ]
        ]
        and
        OperatorExpr [
          FieldAccessor [
            Variable [ Name=o ]
            Field=o_orderdate
          ]
          >=
          LiteralExpr [STRING] [1994-01-01]
        ]
        and
        OperatorExpr [
          FieldAccessor [
            Variable [ Name=o ]
            Field=o_orderdate
          ]
          <
          LiteralExpr [STRING] [1995-01-01]
        ]
      ]
  )
  AS
  Variable [ Name=o1 ]
]
Where
  OperatorExpr [
    OperatorExpr [
      FieldAccessor [
        Variable [ Name=c ]
        Field=c_nationkey
      ]
      =
      FieldAccessor [
        Variable [ Name=o1 ]
        Field=s_nationkey
      ]
    ]
    and
    OperatorExpr [
      FieldAccessor [
        Variable [ Name=c ]
        Field=c_custkey
      ]
      =
      FieldAccessor [
        Variable [ Name=o1 ]
        Field=o_custkey
      ]
    ]
  ]
Groupby
  Variable [ Name=n_name ]
  :=
  FieldAccessor [
    Variable [ Name=o1 ]
    Field=n_name
  ]
  With
  Variable [ Name=o1 ]
  Variable [ Name=c ]

LetVariable [ Name=revenue ]
  :=
  FunctionCall q5_local_supplier.sum@1[
    (
      SELECT ELEMENT [
      OperatorExpr [
        FieldAccessor [
          Variable [ Name=i ]
          Field=l_extendedprice
        ]
        *
        OperatorExpr [
          LiteralExpr [LONG] [1]
          -
          FieldAccessor [
            Variable [ Name=i ]
            Field=l_discount
          ]
        ]
      ]
      ]
      FROM [        Variable [ Name=o1 ]
        AS
        Variable [ Name=i ]
      ]
    )
  ]
Orderby
  Variable [ Name=revenue ]
  DESC

